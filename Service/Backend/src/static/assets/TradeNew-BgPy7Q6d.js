import{d as L,r as O,m,y as g,z as R,w as d,C as U,o as b,c as v,a as c,b as q,v as D,F as z,t as H,q as S,e as J,h,k as f,x as Q,l as W,_ as X}from"./index-CK62fWor.js";import{_ as Y}from"./CustomForm.vue_vue_type_script_setup_true_lang-CDWfceke.js";import"./CustomSelect.vue_vue_type_script_setup_true_lang-S8JB5u0-.js";const Z={class:"container"},P={class:"m-4"},ee={class:"text-center"},te={class:"text-center"},ae={class:"text-center"},se={key:0,class:"text-center coupon-ok"},ne=L({__name:"TradeNew",setup(oe){const x=[{text:"入金",value:"money_in"}],I=[{text:"入金",value:"money_in"},{text:"出金",value:"money_out"}],n=O([{step:0,label:"遊戲類別",type:"select",depValue:"game_id"},{step:1,label:"遊戲暱稱",type:"searchList",depValue:"member_id"},{step:2,label:"庫存角色",type:"select",depValue:"stock_id",required:!0},{step:2,label:"資產",type:"select",depValue:"property_id",required:!0},{step:2,label:"出入金類型",type:"select",depValue:"base_type",required:!0,options:I},{step:2,label:"金額",type:"number",depValue:"money",required:!0},{step:2,label:"交易手續費",type:"number",depValue:"charge_fee",required:!0,disabled:!0},{step:2,label:"遊戲幣",type:"number",depValue:"game_coin",required:!0,disabled:!0},{step:2,label:"遊戲幣手續費",type:"number",depValue:"game_coin_fee",required:!0,disabled:!0}]),t=O({}),r=m({}),C=[{step:1,color:"secondary",text:"重新選擇遊戲",method:()=>i.value=0},{step:2,color:"secondary",text:"重新選擇會員",method:()=>i.value=1},{step:2,color:"primary",text:"新增",method:()=>A(),needValid:!0}],k=m([]),l=m([]),u=m(!1),i=m(0),T=g(()=>{var s;let e=n.findIndex(o=>o.depValue=="member_id"),a=(s=n[e].options)==null?void 0:s.find(o=>o.value==t.member_id);return a?a.text:""}),_=g(()=>{let e="";return k.value.forEach(a=>{a.id==t.property_id&&(e=a.kind)}),e}),V=g(()=>u.value&&t.money>=r.value.money_floor);R(()=>{M()}),d(i,e=>{switch(e){case 0:t.game_id="";break;case 1:t.member_id="",t.base_type="",t.property_id="",t.money="";break;case 2:w()}}),d(()=>t.game_id,e=>{if(e){let a=n.findIndex(o=>o.depValue=="member_id"),s=l.value.filter(o=>o.games[0].id==e);n[a].options=s.map(o=>({text:o.nickname,value:o.id})),i.value=1}}),d(()=>t.member_id,e=>{if(e){let a=l.value.find(s=>s.id==e);$(a==null?void 0:a.games[0].id),i.value=2}}),d(()=>t.base_type,e=>{let a=n.findIndex(o=>o.depValue=="money"),s=n.findIndex(o=>o.depValue=="charge_fee");e!=""?(n[a].disabled=!1,n[s].disabled=e!="money_out",F()):n[a].disabled=!0}),d(_,e=>{let a=l.value.find(o=>o.id==t.member_id),s=n.findIndex(o=>o.depValue=="base_type");t.base_type="",t.charge_fee=0,t.money=0,e=="bank"?n[s].options=I:e=="supermarket"?(t.charge_fee=a==null?void 0:a.game_info.charge_fee,n[s].options=x,t.base_type="money_in"):e=="v_account"&&(n[s].options=x,t.base_type="money_in")}),d(()=>t.money,e=>{if(e>=0&&F(),_.value=="supermarket"){let a=n.findIndex(s=>s.depValue=="charge_fee");if(e>=2e3)n[a].label="交易手續費 (滿額免費)",t.charge_fee=0;else{let s=l.value.find(o=>o.id==t.member_id);n[a].label="交易手續費",t.charge_fee=s==null?void 0:s.game_info.charge_fee}}}),d(V,e=>{let a=n.findIndex(s=>s.depValue=="money");if(e){let s=t.money-r.value.money_free,o=`${t.money} - ${r.value.money_free} = ${s}`;n[a].description=o}else n[a].description=""});const F=()=>{let e=l.value.find(a=>a.id==t.member_id);t.base_type=="money_in"?t.game_coin=t.money*(e?e.games[0].money_in_exchange:0):t.base_type=="money_out"?t.game_coin=t.money*(e?e.games[0].money_out_exchange:0):t.game_coin=0,t.game_coin=Math.ceil(t.game_coin),t.game_coin_fee=Math.ceil(t.game_coin*(e?e.games[0].game_coin_fee:0))},M=()=>{U(["/apis/members?count=100&page=1","/apis/properties?count=100&page=1","/apis/games"]).then(e=>{B(e[0].data),j(e[1].data),G(e[2].data)})},G=e=>{let a=n.findIndex(s=>s.depValue=="game_id");n[a].options=e.map(s=>({text:s.name,value:s.id}))},$=e=>{h("get",`/apis/stocks?game_id=${e}`).then(a=>{K(a.data)})},B=e=>{l.value=e.map(a=>a)},K=e=>{let a=n.findIndex(s=>s.depValue=="stock_id");n[a].options=e.map(s=>({text:s.role_name,value:s.id}))},j=e=>{let a=n.findIndex(s=>s.depValue=="property_id");k.value=e,n[a].options=e.map(s=>({text:s.name,value:s.id}))},w=()=>{h("get","/apis/coupons").then(e=>{e.data.length>0?(r.value=e.data[0],u.value=!0):u.value=!1})},A=()=>{let e=new Date(Date.now()),a=new Date(r.value.start_time),s=new Date(r.value.end_time);if(u.value)if(a<e&&e<s)f("success","符合活動資格 !");else{w(),f("error",["已不在活動時間內 !","已重新載入活動資訊"]);return}h("post","/apis/trades",E()).then(()=>{var N;let o=n.findIndex(y=>y.depValue=="property_id"),p=(N=n[o].options)==null?void 0:N.find(y=>y.value==t.property_id);f("success","建立成功"),Q("/properties/details",{showTitle:p==null?void 0:p.text,showKind:_.value,showId:p==null?void 0:p.value})}).catch(o=>{console.log(o),f("error","建立失敗")})},E=()=>{let e={member_id:t.member_id,property_id:t.property_id,stock_id:t.stock_id,base_type:t.base_type,money:t.money,charge_fee:t.charge_fee,game_coin:t.game_coin,game_coin_fee:t.game_coin_fee,first_check:W.shift};switch(_.value){case"supermarket":e.stage_fee=5;break;case"v_account":e.stage_fee=-10;break}return e};return(e,a)=>(b(),v("div",Z,[c("div",P,[a[2]||(a[2]=c("h3",{class:"text-center"},"新增交流單",-1)),q(c("h3",ee,"選擇遊戲類別",512),[[D,i.value==0]]),q(c("h3",te,"選擇會員",512),[[D,i.value==1]]),i.value==2?(b(),v(z,{key:0},[c("h3",ae,'會員 "'+H(T.value)+'" 新增交流單',1),V.value?(b(),v("div",se,a[1]||(a[1]=[c("p",null,"*** 符合優惠條件 ***",-1)]))):S("",!0)],64)):S("",!0)]),J(Y,{fields:n,hasStep:"",currentStep:i.value,buttons:C,formData:t,"onUpdate:formData":a[0]||(a[0]=s=>t=s)},null,8,["fields","currentStep","formData"])]))}}),le=X(ne,[["__scopeId","data-v-88e7f7bf"]]);export{le as default};
